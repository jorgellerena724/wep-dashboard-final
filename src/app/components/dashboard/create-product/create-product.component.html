<form [formGroup]="form" class="space-y-4 max-h-[70vh] pr-4 w-[420]">
  <div class="mb-4 grid grid-cols-2 gap-4">
    <app-text-field
      id="title"
      label="{{ 'components.products.create.fields.name.title' | transloco }}"
      [control]="form.get('title')"
      [errorMessages]="{
        required: ( 'components.products.create.fields.name.required' | transloco ),
        minlength: ( 'components.products.create.fields.name.minlength' | transloco ),
        duplicateTitle: ( 'components.products.create.fields.name.duplicateTitle' | transloco ),
      }"
    ></app-text-field>
    <app-select
      [placeholder]="
        'components.products.create.fields.category.title' | transloco
      "
      [options]="categories"
      formControlName="category"
      [control]="form.get('category')"
      [errorMessages]="{
        required: ( 'components.products.create.fields.category.required' | transloco ),
      }"
    ></app-select>
  </div>
  <div *ngIf="showCalUrlField">
    <app-text-field
      id="cal_url"
      label="{{ 'components.products.create.fields.calurl.title' | transloco }}"
      [control]="form.get('cal_url')"
    ></app-text-field>
  </div>

  <!-- Sección de Variantes -->
  <hr class="border-gray-500 my-1 border-opacity-10" />
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h4
        class="text-black text-sm mb-1 dark:text-[rgb(209,213,219)] font-bold"
      >
        {{ "components.products.create.fields.variants.title" | transloco }}
      </h4>
      <button
        type="button"
        (click)="addVariant()"
        class="flex items-center gap-2 px-3 py-2 text-sm text-white rounded-lg transition-colors bg-gray-800 hover:bg-gray-700"
      >
        <i class="pi pi-plus"></i>
        <span>{{
          "components.products.create.fields.variants.add" | transloco
        }}</span>
      </button>
    </div>

    <!-- Lista de variantes existentes -->
    <div *ngIf="variants.length > 0" class="space-y-3">
      <div
        *ngFor="let variant of variants; let i = index"
        class="flex items-start gap-3 p-4 bg-white dark:bg-white rounded-lg border border-black"
      >
        <div class="flex-1 grid grid-cols-2 gap-3">
          <app-text-field
            [id]="'variant-description-' + i"
            label="{{
              'components.products.create.fields.variants.description.title'
                | transloco
            }}"
            [control]="getVariantControl(i, 'description')"
            [errorMessages]="{
              required: ( 'components.products.create.fields.variants.description.required' | transloco ),
            }"
          ></app-text-field>
          <app-text-field
            [id]="'variant-price-' + i"
            label="{{
              'components.products.create.fields.variants.price.title'
                | transloco
            }}"
            placeholder="{{
              'components.products.create.fields.variants.price.optional'
                | transloco
            }}"
            [control]="getVariantControl(i, 'price')"
            [allowDecimals]="true"
            [numbersOnly]="true"
          ></app-text-field>
        </div>

        <button
          type="button"
          (click)="removeVariant(i)"
          class="p-2 text-red-500 dark:hover:bg-red-900/20 rounded-full transition-colors"
        >
          <i class="pi pi-trash"></i>
        </button>
      </div>
    </div>

    <!-- Estado vacío para variantes -->
    <div
      *ngIf="variants.length === 0"
      class="p-4 bg-white dark:bg-white rounded-lg border border-black"
    >
      <div class="text-center py-8">
        <i
          class="pi pi-list text-3xl text-gray-300 dark:text-gray-600 mb-3 block"
        ></i>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          {{ "components.products.create.fields.variants.empty" | transloco }}
        </p>
      </div>
    </div>
  </div>

  <hr class="border-gray-500 my-1 border-opacity-10" />
  <app-text-field
    id="description"
    label="{{
      'components.products.create.fields.description.title' | transloco
    }}"
    [control]="form.get('description')"
    [isTextArea]="true"
    textAreaHeight="h-56"
    [errorMessages]="{
        required: ( 'components.products.create.fields.description.required' | transloco ),
        minlength: ( 'components.products.create.fields.description.minlength' | transloco ),
      }"
  ></app-text-field>

  <hr class="border-gray-500 my-1 border-opacity-10" />

  <!-- Sección de Archivos Múltiples -->
  <div class="space-y-4">
    <!-- File Upload - Ahora con múltiple -->
    <app-file-upload
      #fileUpload
      label="{{ 'components.products.create.fields.image.title' | transloco }}"
      accept="image/*,video/mp4,video/quicktime"
      [maxFileSize]="1024 * 1024 * 20"
      [multiple]="true"
      fileUploadText="{{ 'image.select' | transloco }}"
      fileRecommendation="{{
        'components.products.create.fields.image.recommendation' | transloco
      }}"
      (fileSelected)="onFileUploaded($event)"
      (fileError)="onFileError($event)"
    ></app-file-upload>

    <!-- Información sobre carga de imágenes -->
    <div class="text-md text-gray-500">
      <small>{{
        "components.products.create.fields.image.uploadInfo" | transloco
      }}</small>
    </div>

    <!-- Información sobre imagen principal -->
    <div class="text-md text-gray-500">
      <small>
        {{
          "components.products.edit.fields.image.mainImageInfo" | transloco
        }}</small
      >
    </div>

    <!-- Mensaje de error cuando no hay archivos -->
    <div
      *ngIf="
        filesFormArray.invalid &&
        filesFormArray.touched &&
        productFiles.length === 0
      "
      class="mt-1 text-sm text-red-500"
    >
      <ul class="list-disc pl-4">
        <li>
          {{ "components.products.create.fields.image.required" | transloco }}
        </li>
      </ul>
    </div>

    <!-- Lista de archivos cargados -->
    <div *ngIf="productFiles.length > 0" class="space-y-4">
      <div
        *ngFor="let productFile of productFiles; let i = index"
        class="flex items-start gap-3 p-4 bg-white dark:bg-white rounded-lg border border-black relative"
      >
        <!-- Badge de imagen principal -->
        <div
          *ngIf="i === 0"
          class="absolute -top-2 -left-2 bg-gray-800 dark:bg-gray-700 text-white text-xs px-3 py-1 rounded-full font-bold shadow-lg z-10 flex items-center gap-1"
        >
          <i class="pi pi-star-fill"></i>
        </div>
        <!-- Preview -->
        <div
          class="flex-shrink-0 w-32 h-32 flex items-center justify-center bg-gray-100 rounded-lg border"
        >
          <div class="relative w-full h-full flex items-center justify-center">
            <!-- Imagen -->
            <div
              *ngIf="!productFile.isVideo && productFile.previewUrl"
              class="w-full h-full flex items-center justify-center"
            >
              <img
                [src]="productFile.previewUrl"
                class="max-w-full max-h-full object-contain rounded-lg"
                alt="Preview"
              />
            </div>

            <!-- Video - Mejorado -->
            <div
              *ngIf="productFile.isVideo && productFile.videoUrl"
              class="w-full h-full flex items-center justify-center bg-black rounded-lg"
            >
              <video
                controls
                controlsList="nodownload"
                [src]="productFile.videoUrl"
                class="w-full h-full object-contain rounded-lg"
                #videoPlayer
                (loadedmetadata)="onVideoLoaded($event, videoPlayer)"
                poster="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
              >
                <div
                  class="absolute inset-0 flex items-center justify-center bg-black text-white p-2 text-xs"
                >
                  <p>{{ "video.unsupported" | transloco }}</p>
                </div>
              </video>
              <div
                class="absolute bottom-2 left-2 bg-black bg-opacity-70 rounded px-2 py-1"
              >
                <i class="pi pi-play text-white text-sm"></i>
              </div>
            </div>

            <!-- Icono si no hay preview -->
            <div
              *ngIf="!productFile.previewUrl && !productFile.videoUrl"
              class="text-gray-400"
            >
              <i class="pi pi-image text-2xl"></i>
            </div>
          </div>
        </div>

        <!-- Campo de título - Ahora completamente opcional -->
        <div class="flex-1">
          <app-text-field
            [id]="'file-title-' + i"
            [control]="getFileControl(i, 'title')"
            placeholder="{{
              'components.products.create.fields.image.titlePlaceholder'
                | transloco
            }}"
          ></app-text-field>
        </div>

        <!-- Botones de reordenamiento -->
        <div class="flex flex-col gap-1">
          <!-- Botón subir -->
          <button
            type="button"
            (click)="moveFileUp(i)"
            [disabled]="i === 0"
            [class.opacity-30]="i === 0"
            [class.cursor-not-allowed]="i === 0"
            class="p-2 text-gray-700 dark:text-gray-300 rounded transition-colors"
            pTooltip="{{
              i === 0
                ? ('components.products.create.fields.image.firstImage'
                  | transloco)
                : ('components.products.create.fields.image.moveUp' | transloco)
            }}"
            tooltipPosition="top"
          >
            <i class="pi pi-chevron-up"></i>
          </button>
          <!-- Botón bajar -->
          <button
            type="button"
            (click)="moveFileDown(i)"
            [disabled]="i === productFiles.length - 1"
            [class.opacity-30]="i === productFiles.length - 1"
            [class.cursor-not-allowed]="i === productFiles.length - 1"
            class="p-2 text-gray-700 dark:text-gray-300 rounded transition-colors"
            pTooltip="{{
              i === productFiles.length - 1
                ? ('components.products.create.fields.image.lastImage'
                  | transloco)
                : ('components.products.create.fields.image.moveDown'
                  | transloco)
            }}"
            tooltipPosition="top"
          >
            <i class="pi pi-chevron-down"></i>
          </button>
        </div>

        <!-- Botón eliminar -->
        <button
          type="button"
          (click)="removeFile(i)"
          class="p-2 text-red-500 dark:hover:bg-red-900/20 rounded-full transition-colors"
          pTooltip="{{
            'components.products.create.fields.image.deleteImage' | transloco
          }}"
          tooltipPosition="top"
        >
          <i class="pi pi-trash"></i>
        </button>
      </div>
    </div>

    <!-- Estado vacío para archivos -->
    <div
      *ngIf="productFiles.length === 0"
      class="p-4 bg-white dark:bg-white rounded-lg border border-black"
    >
      <div class="text-center py-8">
        <i
          class="pi pi-image text-3xl text-gray-300 dark:text-gray-600 mb-3 block"
        ></i>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          {{ "image.nodata.title" | transloco }}
        </p>
      </div>
    </div>
  </div>
</form>

<style>
  :host ::ng-deep .p-fileupload-content {
    display: none !important;
  }
  :host ::ng-deep app-file-upload label {
    font-weight: bold !important;
    color: black !important;
    font-size: 14px;
  }

  /* Mejoras para el reproductor de video */
  :host ::ng-deep video {
    border-radius: 0.5rem;
  }

  :host ::ng-deep video::-webkit-media-controls-panel {
    background-image: linear-gradient(transparent, transparent) !important;
  }

  :host ::ng-deep video::-webkit-media-controls-play-button {
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
  }
</style>
