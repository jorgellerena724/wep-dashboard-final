<!-- update-header.component.html -->
<form [formGroup]="form" class="space-y-4 max-h-[70vh] pr-4 w-[420]">
  <div class="mb-4 grid grid-cols-2 gap-4">
    <app-text-field
      id="title"
      label="{{ 'components.products.edit.fields.name.title' | transloco }}"
      [control]="form.get('title')"
      [errorMessages]="{
        required: ( 'components.products.edit.fields.name.required' | transloco ),
        minlength: ( 'components.products.edit.fields.name.minlength' | transloco ),
        maxlength: ( 'components.products.edit.fields.name.maxlength' | transloco ),
      }"
    ></app-text-field>
    <app-select
      [placeholder]="
        'components.products.edit.fields.category.title' | transloco
      "
      [options]="categories"
      formControlName="category"
      [control]="form.get('category')"
      [errorMessages]="{
        required: ( 'components.products.edit.fields.category.required' | transloco ),
      }"
    ></app-select>
  </div>
  <div class="mb-4">
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-medium text-gray-700 dark:text-gray-300">
        {{ "components.products.edit.fields.variants.title" | transloco }}
      </h3>
      <button
        type="button"
        (click)="addVariant()"
        class="flex items-center gap-2 px-3 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
      >
        <i class="pi pi-plus mr-1"></i>
        {{ "components.products.edit.fields.variants.add" | transloco }}
      </button>
    </div>

    <div
      *ngFor="let variant of variants; let i = index"
      class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg mb-2"
    >
      <div class="grid grid-cols-2 gap-3">
        <app-text-field
          [id]="'variant-description-' + i"
          label="{{
            'components.products.edit.fields.variants.description.title'
              | transloco
          }}"
          [control]="getVariantControl(i, 'description')"
          [errorMessages]="{
              required: ( 'components.products.edit.fields.variants.description.required' | transloco ),
            }"
        ></app-text-field>
        <app-text-field
          [id]="'variant-price-' + i"
          label="{{
            'components.products.edit.fields.variants.price.title' | transloco
          }}"
          [control]="getVariantControl(i, 'price')"
          [allowDecimals]="true"
          [numbersOnly]="true"
          [errorMessages]="{
              required: ( 'components.products.edit.fields.variants.price.required' | transloco ),
            }"
        ></app-text-field>
      </div>

      <div class="mt-2 text-right">
        <button
          type="button"
          (click)="removeVariant(i)"
          class="text-red-500 hover:text-red-700 text-sm"
        >
          <i class="pi pi-trash mr-1"></i>
        </button>
      </div>
    </div>

    <div
      *ngIf="variants.length === 0"
      class="text-center py-4 text-gray-500 dark:text-gray-400 italic"
    >
      {{ "components.products.edit.fields.variants.empty" | transloco }}
    </div>
    <!-- Mensaje informativo -->
    <p
      *ngIf="variants.length !== 0"
      class="text-xs text-gray-500 dark:text-gray-400"
    >
      <i class="pi pi-info-circle mr-1"></i>
      {{ "components.products.edit.fields.variants.info" | transloco }}
    </p>
  </div>
  <hr class="border-gray-500 my-1 border-opacity-10" />
  <app-text-field
    id="description"
    label="{{
      'components.products.edit.fields.description.title' | transloco
    }}"
    [control]="form.get('description')"
    [isTextArea]="true"
    textAreaHeight="h-56"
    [errorMessages]="{
        required: ( 'components.products.edit.fields.description.required' | transloco ),
        minlength: ( 'components.products.edit.fields.description.minlength' | transloco ),
      }"
  ></app-text-field>
  <hr class="border-gray-500 my-1 border-opacity-10" />
  <div class="field">
    <!-- File Upload -->
    <app-file-upload
      #fileUpload
      label="{{ 'components.news.edit.fields.image.title' | transloco }}"
      accept="image/*,video/mp4,video/quicktime"
      [maxFileSize]="1024 * 1024 * 20"
      fileUploadText="{{ 'image.select' | transloco }}"
      fileRecommendation="{{
        'components.news.edit.fields.image.recommendation' | transloco
      }}"
      (fileSelected)="onFileUploaded($event)"
      (fileRemoved)="removeFile()"
      (fileError)="onFileError($event)"
    ></app-file-upload>
    <!-- Contenedor de altura fija para la previsualizaciÃ³n -->
    <div class="mt-4 relative h-[240px]">
      <!-- Loading state -->
      <div
        *ngIf="loadingImage"
        class="absolute inset-0 flex items-center justify-center bg-gray-50 dark:bg-gray-800 rounded-lg"
      >
        <div class="text-center">
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"
          ></div>
          <span class="text-gray-600 dark:text-gray-300 text-sm">{{
            "image.loading" | transloco
          }}</span>
        </div>
      </div>

      <!-- Preview Section: Imagen o Video -->
      <div
        *ngIf="(imageUrl || videoUrl) && !loadingImage"
        class="absolute inset-0 flex flex-col"
      >
        <!-- Preview Container -->
        <div class="flex-1 flex items-center justify-center">
          <div class="relative inline-block">
            <!-- Image Preview -->
            <div
              *ngIf="imageUrl"
              class="relative overflow-hidden rounded-lg shadow-md border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800"
            >
              <img
                [src]="imageUrl"
                class="max-w-[280px] max-h-[240px] min-w-[200px] min-h-[150px] object-contain p-2"
                alt="{{ 'image.alt' | transloco }}"
              />
            </div>

            <!-- Video Preview -->
            <div
              *ngIf="videoUrl"
              class="relative overflow-hidden rounded-lg shadow-md border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800"
            >
              <video
                controls
                [src]="videoUrl"
                class="max-w-[280px] max-h-[240px] min-w-[200px] min-h-[150px] object-contain p-2"
                #videoPlayer
                (loadedmetadata)="videoPlayer.muted = true"
              >
                <div
                  class="absolute inset-0 flex items-center justify-center bg-black text-white p-4"
                >
                  <p>
                    {{ "video.unsupported" | transloco }}
                  </p>
                </div>
              </video>
            </div>

            <!-- Delete Button -->
            <button
              type="button"
              (click)="removeFile()"
              class="absolute top-0 right-2 text-red-500 bg-transparent hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-200 p-1 rounded-full"
              tooltipPosition="top"
            >
              <i class="pi pi-trash text-lg"></i>
            </button>
          </div>
        </div>
        <!-- Info Message -->
        <div class="mt-auto pt-3">
          <p class="text-sm text-gray-600 dark:text-gray-400 text-center">
            <i class="pi pi-info-circle mr-1"></i>
            {{
              isVideo ? ("video.info" | transloco) : ("image.info" | transloco)
            }}
          </p>
        </div>
      </div>

      <!-- Estado cuando no hay archivo -->
      <div
        *ngIf="!imageUrl && !videoUrl && !loadingImage"
        class="absolute inset-0 flex items-center justify-center"
      >
        <div
          [class.border-red-500]="
            form.get('image')?.invalid && form.get('image')?.touched
          "
          [class.border-gray-500]="
            !(form.get('image')?.invalid && form.get('image')?.touched)
          "
          class="w-full h-full flex flex-col items-center justify-center p-6 border-2 border-dashed rounded-lg bg-gray-50/50 dark:bg-gray-800/50"
        >
          <i
            class="pi pi-image text-4xl text-gray-400 dark:text-gray-500 mb-3"
          ></i>
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center">
            <span class="block font-medium">{{
              "image.nodata.title" | transloco
            }}</span>
            <span class="block text-xs mt-1 opacity-75">
              {{ "image.nodata.subtitle" | transloco }}
            </span>
          </p>
        </div>
      </div>
    </div>
    <div
      *ngIf="form.get('image')?.invalid && form.get('image')?.touched"
      class="text-red-500 text-sm mt-2 mb-2"
    >
      {{ "image.required" | transloco }}
    </div>
  </div>
</form>
<style>
  /* Estilos para override de PrimeNG */
  :host ::ng-deep .p-fileupload-content {
    display: none !important;
  }
  :host ::ng-deep app-file-upload label {
    font-weight: bold !important;
    color: black !important;
    font-size: 14px;
  }
</style>
